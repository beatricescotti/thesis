\chapter{Medical Dataset}

\section{NLST - National Lung Screening Trial Dataset}
The aggressive and heterogeneous nature of lung cancer has thwarted efforts to reduce mortality from this cancer through the use of screening. 
The advent of low-dose helical computed tomography (CT) altered the landscape of lung-cancer screening, with studies indicating that low-dose CT detects many tumors at early stages.
 The National Lung Screening Trial (NLST) was conducted to determine whether screening with low-dose CT could reduce mortality from lung cancer.
The NLST was a large, multicenter, randomized controlled trial that enrolled over 53,000 participants at high risk for lung cancer. 
Participants were randomly assigned to receive either low-dose CT scans or standard chest X-rays. 
The primary outcome was lung cancer mortality, with secondary outcomes including the detection of early-stage lung cancer and the impact of screening on overall mortality.

Radiologists at the screening centers reviewed the images obtained at each of the three annual screening exams to check for signs of lung cancer.

The image review was made without reference to any historical images. The radiologist recorded information about all visible abnormalities and assigned a preliminary screening result. A positive screening result (suspicious for lung cancer) was assigned if any non-calcified nodules or masses $\geq 4 mm$ in diameter were noted or if any other abnormalities were judged suspicious for lung cancer by the radiologist.

\subsection{Dataset Pruning}
The NLST dataset contains chest CT scans where each scan comprises multiple ($\sim 143$) axial slices. 
Notably, not all slices include tumor lesions. The dataset was then pruned by filtering slices based on a provided CSV file that identifies slices containing clinically relevant findings. After pruning, approximately 9,000 slices remain with malignant lesions with $\geq 4 mm$ in diameter. 
However, benign tumor slices lack bounding box annotations, which presents a limitation for detection tasks.

The annotations are in the form of a CSV file that contains the following columns:
\begin{itemize}
    \item \textbf{PID}: Unique identifier for each patient.
    \item \textbf{Slice Number}: The specific slice within the CT scan, which is also the name of the file.
    \item \textbf{CT filter}: Indicates the type of filter applied to the CT scan.
    \item \textbf{x, y, width, height}: Coordinates of the bounding box around the lesion, x and y represent the top-left corner of the bounding box, while width and height represent its dimensions.
\end{itemize}

\subsection{Extraction of the pixel array}
The CT images are in the dicom format, which is a standard format for medical imaging data. Each CT scan consists of multiple slices, and each slice is represented as a 2D image. The pixel values in these images are typically stored in Hounsfield units (HU), which represent the radiodensity of the tissue.
A dicom file contains:
\begin{itemize}
    \item \textbf{Pixel Array}: The pixel array is a 2D array of pixel values that represent the intensity of the image. Each pixel value corresponds to a specific location in the image and is typically stored as a 16-bit integer.
    \item \textbf{Metadata}: The metadata contains information about the image, such as the patient's name, the acquisition date, the image orientation, pixel spacing, and slice thickness. This information is essential for interpreting the image correctly.
\end{itemize}

\subsection{Image Metadata}
The metadata of a CT image contains important information about the image acquisition parameters and the physical characteristics of the image. The following are some key metadata fields commonly found in CT images:
\begin{itemize}
    \item \textbf{Pixel Spacing (mm)}: The physical distance between adjacent pixels in the x and y directions, typically measured in millimeters.
    \item \textbf{Slice Thickness (mm)}: The thickness of each slice in the z direction, also measured in millimeters.
    \item \textbf{Field of View (FOV) (cm)}: The physical dimension of the area captured in the image, typically measured in centimeters.
    \item \textbf{Image Orientation}: The orientation of the image, which can be specified using a combination of row and column vectors.
    \item \textbf{Image Position}: The position of the image in 3D space, typically specified using x, y, and z coordinates.
\end{itemize}

\section{CT planes}
In computed tomography (CT), the images are typically acquired in three orthogonal planes: axial, coronal, and sagittal. Each plane provides a different perspective of the anatomical structures within the body.
\begin{itemize}
    \item \textbf{Axial}: horizontal plane that divides the body into upper and lower parts.
    \item \textbf{Coronal}: vertical plane that divides the body into anterior (front) and posterior (back) parts.
    \item \textbf{Sagittal}: vertical plane that divides the body into left and right parts.
\end{itemize}

\begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]{immagini/planes.jpg}
    \caption{CT planes: axial, coronal, and sagittal. The axial plane is horizontal, the coronal plane is vertical and divides the body into front and back, and the sagittal plane is vertical and divides the body into left and right.}
    \label{fig:ct_planes}
\end{figure}




\section{DLCS - Duke Lung Cancer Screening Dataset}
\subsection{Extraction of the 2D slices}
\subsection{Dataset Pruning}

\section{Pre processing the images}
\subsection{Resampling}
\subsection{Windowing}
In computed tomography (CT), the intensity values of the pixels are quantified in \textbf{Hounsfield units (HU)}, a standardized scale that reflects the radiodensity of the tissue. This scale is defined relative to the attenuation coefficients of water and air:
\begin{equation}
    HU_{tissue} = 1000 \times \dfrac{\mu_{tissue} - \mu_{water}}{\mu_{water}-\mu_{air}}
\end{equation}
where $\mu$ represents the linear attenuation coefficient. Key reference points: water = 0 HU for definition, air = -1000 HU. \\
\textbf{Windowing} is a technique used in computed tomography (CT) to \textbf{enhance the visibility of specific tissues or structures within the body.} It involves adjusting the range of Hounsfield units (HU) displayed in the CT image, allowing radiologists to focus on particular types of tissues, such as bones, soft tissues, or air-filled spaces. The window width and center determine the contrast and brightness of the image, respectively.
\begin{itemize}
    \item \textbf{Window width} (WW): This parameter controls the range of Hounsfield units displayed in the image. A narrow window width enhances the contrast between tissues with similar densities, while a wider window width allows a broader range of densities to be visualized.
    \item \textbf{Window center} (WC): This parameter sets the midpoint of the Hounsfield unit range displayed in the image. Adjusting the window level changes the brightness of the image, allowing radiologists to focus on specific tissue types.
\end{itemize}
The choice of window width and level depends on the specific clinical question and the type of tissue being examined. 

\begin{figure}
    \centering
    \includegraphics[width=0.75\textwidth]{immagini/other_windowing.png}
    \caption{CT Hounsfield Unit (HU) ranges for key tissues. Highlighted regions show typical HU values for diagnostic reference, from dense compact bone ($\sim 3000$ HU ) to air ($1000$ HU), with soft tissues ($20-80$ HU) and fluids (blood $\sim 45$ HU, water $0$ HU) in intermediate ranges.}
    \label{fig:general_windowing}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.75\textwidth]{immagini/windowing.png}
    \caption{Standard CT windowing settings for different anatomical structures. Full CT value range ([-1000, 3000] HU). Clinical presets with window center (WC) and width (WW) values for bone (WC=1000, WW=2500), mediastinum (WC=-50, WW=400), and lung (WC=-600, WW=1700) visualization.}
    \label{fig:windowing_lung}
\end{figure}


\begin{lstlisting}[style=mystyle]
    window_center = -600    
    window_width = 1700   
    window_min = window_center - window_width // 2
    window_max = window_center + window_width // 2

    array = np.load(array_path)
    array_windowed = np.clip(array, window_min, window_max)  
    array_normalized = 255*(array_windowed - window_min)/(window_width)
    array_uint8 = array_normalized.astype(np.uint8) 

    img = Image.fromarray(array_uint8)
\end{lstlisting}


\begin{figure}[htbp]
    \centering
    \begin{minipage}[b]{0.6\textwidth}
        \centering
        \includegraphics[width=\linewidth, height=5cm, keepaspectratio]{immagini/slice_DLCS_0001_DLCS_0001_01_n0.png}
        \label{fig:image_a}
    \end{minipage}
    \hfill
    \begin{minipage}[b]{0.6\textwidth}
        \centering
        \includegraphics[width=\linewidth, height=5cm, keepaspectratio]{immagini/slice_DLCS_0001_DLCS_0001_01_n0_1.png}
        \label{fig:image_b}
    \end{minipage}
    
    \caption{Didascalia principale delle due immagini affiancate}
    \label{fig:combined}
\end{figure}

\subsubsection{RBG Windowing}
\subsection{Padding}
\subsection{Masking}
